const fs = require('fs');

const documentsPage = [
  "import { redirect } from 'next/navigation'",
  "import Link from 'next/link'",
  "import { createClient } from '@/lib/supabase/server'",
  "import DocumentList from './DocumentList'",
  "",
  "export default async function DocumentsPage({ params }) {",
  "  const { id } = await params",
  "  const supabase = await createClient()",
  "  const { data: { user } } = await supabase.auth.getUser()",
  "  if (!user) redirect('/auth/login')",
  "  const { data: estate } = await supabase.from('estates').select('*').eq('id', id).single()",
  "  if (!estate) redirect('/dashboard')",
  "  const { data: documents } = await supabase.from('documents').select('*, profiles(full_name)').eq('estate_id', id).order('created_at', { ascending: false })",
  "  const { data: categories } = await supabase.from('categories').select('*').eq('estate_id', id).order('ord', { ascending: true })",
  "  return (",
  "    <main className='min-h-screen bg-stone-50'>",
  "      <header className='bg-white border-b border-stone-200 px-6 py-4'>",
  "        <div className='max-w-5xl mx-auto flex items-center gap-4'>",
  "          <Link href='/dashboard' className='text-stone-400 hover:text-stone-600 text-sm'>‚Üê Dashboard</Link>",
  "          <span className='text-lg font-semibold text-stone-800'>üïäÔ∏è AfterCare</span>",
  "        </div>",
  "      </header>",
  "      <div className='max-w-5xl mx-auto px-6 py-10'>",
  "        <div className='mb-8'>",
  "          <h1 className='text-2xl font-semibold text-stone-800'>{estate.deceased_name}</h1>",
  "          <p className='text-stone-500 mt-1'>{estate.name}</p>",
  "        </div>",
  "        <div className='flex gap-1 mb-6 bg-white border border-stone-200 rounded-xl p-1 w-fit'>",
  "          <Link href={'/estate/' + id + '/overview'} className='px-4 py-2 rounded-lg text-stone-600 text-sm font-medium hover:bg-stone-100'>Overview</Link>",
  "          <Link href={'/estate/' + id + '/tasks'} className='px-4 py-2 rounded-lg text-stone-600 text-sm font-medium hover:bg-stone-100'>Tasks</Link>",
  "          <span className='px-4 py-2 rounded-lg bg-stone-800 text-white text-sm font-medium'>Documents</span>",
  "          <Link href={'/estate/' + id + '/members'} className='px-4 py-2 rounded-lg text-stone-600 text-sm font-medium hover:bg-stone-100'>Members</Link>",
  "        </div>",
  "        <DocumentList documents={documents || []} categories={categories || []} estateId={id} userId={user.id} />",
  "      </div>",
  "    </main>",
  "  )",
  "}"
].join('\n');

const documentList = [
  "'use client'",
  "",
  "import { useState, useRef } from 'react'",
  "",
  "function formatBytes(bytes) {",
  "  if (bytes < 1024) return bytes + ' B'",
  "  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB'",
  "  return (bytes / (1024 * 1024)).toFixed(1) + ' MB'",
  "}",
  "",
  "function formatDate(str) {",
  "  return new Date(str).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })",
  "}",
  "",
  "export default function DocumentList({ documents, categories, estateId, userId }) {",
  "  const [docs, setDocs] = useState(documents)",
  "  const [uploading, setUploading] = useState(false)",
  "  const [error, setError] = useState(null)",
  "  const [selectedCategory, setSelectedCategory] = useState('')",
  "  const fileRef = useRef(null)",
  "",
  "  async function handleUpload(e) {",
  "    const file = e.target.files[0]",
  "    if (!file) return",
  "    setUploading(true)",
  "    setError(null)",
  "    const formData = new FormData()",
  "    formData.append('file', file)",
  "    formData.append('estate_id', estateId)",
  "    formData.append('category_id', selectedCategory)",
  "    const res = await fetch('/api/documents', { method: 'POST', body: formData })",
  "    if (res.ok) {",
  "      const newDoc = await res.json()",
  "      setDocs(prev => [newDoc, ...prev])",
  "    } else {",
  "      const data = await res.json()",
  "      setError(data.error || 'Upload failed')",
  "    }",
  "    setUploading(false)",
  "    if (fileRef.current) fileRef.current.value = ''",
  "  }",
  "",
  "  async function handleDownload(doc) {",
  "    const res = await fetch('/api/documents/' + doc.id)",
  "    if (res.ok) {",
  "      const { url } = await res.json()",
  "      window.open(url, '_blank')",
  "    }",
  "  }",
  "",
  "  async function handleDelete(doc) {",
  "    if (!confirm('Delete this document?')) return",
  "    const res = await fetch('/api/documents/' + doc.id, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ estate_id: estateId }) })",
  "    if (res.ok) setDocs(prev => prev.filter(d => d.id !== doc.id))",
  "  }",
  "",
  "  function getFileIcon(type) {",
  "    if (!type) return 'üìÑ'",
  "    if (type.includes('pdf')) return 'üìï'",
  "    if (type.includes('image')) return 'üñºÔ∏è'",
  "    if (type.includes('word') || type.includes('document')) return 'üìù'",
  "    if (type.includes('sheet') || type.includes('excel')) return 'üìä'",
  "    return 'üìÑ'",
  "  }",
  "",
  "  return (",
  "    <div>",
  "      <div className='bg-white border border-stone-200 rounded-xl p-5 mb-6'>",
  "        <h3 className='font-medium text-stone-800 mb-4'>Upload Document</h3>",
  "        <div className='flex gap-3 items-end'>",
  "          <div className='flex-1'>",
  "            <label className='block text-xs font-medium text-stone-600 mb-1'>Category (optional)</label>",
  "            <select value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)} className='w-full border border-stone-300 rounded-lg px-3 py-2 text-sm text-stone-800 focus:outline-none focus:ring-2 focus:ring-stone-400'>",
  "              <option value=''>No category</option>",
  "              {categories.map(cat => (",
  "                <option key={cat.id} value={cat.id}>{cat.icon} {cat.name}</option>",
  "              ))}",
  "            </select>",
  "          </div>",
  "          <div>",
  "            <input ref={fileRef} type='file' onChange={handleUpload} className='hidden' id='file-upload' />",
  "            <label htmlFor='file-upload' className={'cursor-pointer bg-stone-800 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-stone-700 transition-colors ' + (uploading ? 'opacity-50 pointer-events-none' : '')}>",
  "              {uploading ? 'Uploading...' : '+ Upload File'}",
  "            </label>",
  "          </div>",
  "        </div>",
  "        {error && <p className='text-red-600 text-xs mt-2'>{error}</p>}",
  "      </div>",
  "      {docs.length === 0 ? (",
  "        <div className='bg-white border border-stone-200 rounded-xl p-12 text-center'>",
  "          <div className='text-4xl mb-3'>üìÅ</div>",
  "          <p className='text-stone-500'>No documents uploaded yet</p>",
  "        </div>",
  "      ) : (",
  "        <div className='bg-white border border-stone-200 rounded-xl overflow-hidden'>",
  "          <div className='px-5 py-4 border-b border-stone-100'>",
  "            <h3 className='font-medium text-stone-800'>{docs.length} Document{docs.length !== 1 ? 's' : ''}</h3>",
  "          </div>",
  "          <div className='divide-y divide-stone-100'>",
  "            {docs.map(doc => (",
  "              <div key={doc.id} className='flex items-center gap-4 px-5 py-4 hover:bg-stone-50'>",
  "                <span className='text-2xl'>{getFileIcon(doc.file_type)}</span>",
  "                <div className='flex-1 min-w-0'>",
  "                  <p className='text-sm font-medium text-stone-800 truncate'>{doc.name}</p>",
  "                  <p className='text-xs text-stone-400'>{formatBytes(doc.file_size)} ¬∑ {formatDate(doc.created_at)} ¬∑ {doc.profiles ? doc.profiles.full_name : 'Unknown'}</p>",
  "                </div>",
  "                <div className='flex items-center gap-2'>",
  "                  <button onClick={() => handleDownload(doc)} className='text-xs text-stone-500 hover:text-stone-800 border border-stone-200 rounded-lg px-3 py-1.5 hover:bg-stone-50'>Download</button>",
  "                  <button onClick={() => handleDelete(doc)} className='text-xs text-red-500 hover:text-red-700 border border-red-200 rounded-lg px-3 py-1.5 hover:bg-red-50'>Delete</button>",
  "                </div>",
  "              </div>",
  "            ))}",
  "          </div>",
  "        </div>",
  "      )}",
  "    </div>",
  "  )",
  "}"
].join('\n');

const uploadRoute = [
  "import { createClient } from '@/lib/supabase/server'",
  "import { NextResponse } from 'next/server'",
  "",
  "export async function POST(request) {",
  "  const supabase = await createClient()",
  "  const { data: { user } } = await supabase.auth.getUser()",
  "  if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })",
  "  const formData = await request.formData()",
  "  const file = formData.get('file')",
  "  const estate_id = formData.get('estate_id')",
  "  const category_id = formData.get('category_id') || null",
  "  if (!file) return NextResponse.json({ error: 'No file provided' }, { status: 400 })",
  "  const bytes = await file.arrayBuffer()",
  "  const buffer = Buffer.from(bytes)",
  "  const ext = file.name.split('.').pop()",
  "  const fileName = Date.now() + '-' + Math.random().toString(36).slice(2) + '.' + ext",
  "  const filePath = estate_id + '/' + fileName",
  "  const { error: uploadError } = await supabase.storage.from('estate-documents').upload(filePath, buffer, { contentType: file.type })",
  "  if (uploadError) return NextResponse.json({ error: uploadError.message }, { status: 500 })",
  "  const { data: doc, error: dbError } = await supabase.from('documents').insert({",
  "    estate_id,",
  "    category_id: category_id || null,",
  "    name: file.name,",
  "    file_path: filePath,",
  "    file_type: file.type,",
  "    file_size: file.size,",
  "    uploaded_by: user.id",
  "  }).select('*, profiles(full_name)').single()",
  "  if (dbError) return NextResponse.json({ error: dbError.message }, { status: 500 })",
  "  return NextResponse.json(doc)",
  "}"
].join('\n');

const docRoute = [
  "import { createClient } from '@/lib/supabase/server'",
  "import { NextResponse } from 'next/server'",
  "",
  "export async function GET(request, { params }) {",
  "  const supabase = await createClient()",
  "  const { data: { user } } = await supabase.auth.getUser()",
  "  if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })",
  "  const { docId } = await params",
  "  const { data: doc } = await supabase.from('documents').select('*').eq('id', docId).single()",
  "  if (!doc) return NextResponse.json({ error: 'Not found' }, { status: 404 })",
  "  const { data } = await supabase.storage.from('estate-documents').createSignedUrl(doc.file_path, 60)",
  "  return NextResponse.json({ url: data.signedUrl })",
  "}",
  "",
  "export async function DELETE(request, { params }) {",
  "  const supabase = await createClient()",
  "  const { data: { user } } = await supabase.auth.getUser()",
  "  if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })",
  "  const { docId } = await params",
  "  const { estate_id } = await request.json()",
  "  const { data: member } = await supabase.from('estate_members').select('role').eq('estate_id', estate_id).eq('user_id', user.id).eq('status', 'active').single()",
  "  if (!member || (member.role !== 'owner' && member.role !== 'executor')) return NextResponse.json({ error: 'Forbidden' }, { status: 403 })",
  "  const { data: doc } = await supabase.from('documents').select('file_path').eq('id', docId).single()",
  "  if (!doc) return NextResponse.json({ error: 'Not found' }, { status: 404 })",
  "  await supabase.storage.from('estate-documents').remove([doc.file_path])",
  "  await supabase.from('documents').delete().eq('id', docId)",
  "  return NextResponse.json({ success: true })",
  "}"
].join('\n');

fs.mkdirSync('src/app/estate/[id]/documents', { recursive: true });
fs.mkdirSync('src/app/api/documents/[docId]', { recursive: true });
fs.writeFileSync('src/app/estate/[id]/documents/page.tsx', documentsPage);
fs.writeFileSync('src/app/estate/[id]/documents/DocumentList.tsx', documentList);
fs.writeFileSync('src/app/api/documents/route.ts', uploadRoute);
fs.writeFileSync('src/app/api/documents/[docId]/route.ts', docRoute);
console.log('All done!');
console.log('page.tsx: ' + fs.statSync('src/app/estate/[id]/documents/page.tsx').size);
console.log('DocumentList.tsx: ' + fs.statSync('src/app/estate/[id]/documents/DocumentList.tsx').size);
console.log('upload route: ' + fs.statSync('src/app/api/documents/route.ts').size);
console.log('doc route: ' + fs.statSync('src/app/api/documents/[docId]/route.ts').size);
